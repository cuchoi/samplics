<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>samplics.sae.eb_unit_model &#8212; samplics 0.3.5 documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/_source/samplics_style.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/samplics_style.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          Sample Analytics</a>
        <span class="navbar-text navbar-version pull-left"><b>0.3.5</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../gettingstarted.html">Getting started</a></li>
                <li><a href="../../../tutorial/index.html">Tutorial</a></li>
                <li><a href="https://github.com/survey-methods/samplics">Github</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Documentation <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted.html">How to get started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../gettingstarted.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../gettingstarted.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../gettingstarted.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../gettingstarted.html#contributing">Contributing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../gettingstarted.html#license">License</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/index.html">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial/index.html#datasets-for-the-tutorial">Datasets for the tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial/index.html#sample-size-calculation">Sample size calculation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorial/sample_size_calculation.html">Sample size calculation for stage sampling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial/index.html#sample-selection">Sample selection</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorial/psu_selection.html">Selection of primary sampling units (PSUs)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorial/ssu_selection.html">Selection of secondary sampling units (SSUs)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial/index.html#sample-weighting">Sample weighting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorial/sample_weights.html">Sample weight adjustment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorial/replicate_weights.html">Replicate weights</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial/index.html#population-parameters-estimation">Population parameters estimation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorial/estimation.html">Estimation of population parameters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial/index.html#categorical-data-analysis">Categorical data analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorial/tabulation.html">Tabulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorial/ttest.html">T-test</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial/index.html#small-area-estimation-sae">Small Area Estimation (SAE)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorial/eblup_area_model.html">Area level model: empirical best linear unbiased predictor (EBLUP)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorial/eblup_unit_model.html">Unit level model: empirical best linear unbiased Prediction (EBLUP)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../usecases.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">API Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../samplics.sampling.html">Sampling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../samplics.sampling.html#module-samplics.sampling.selection">samplics.sampling.selection</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../samplics.weighting.html">Weighting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../samplics.weighting.html#module-samplics.weighting.adjustment">samplics.weighting.adjustment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../samplics.weighting.html#module-samplics.weighting.replicates">samplics.weighting.replicates</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../samplics.estimation.html">Estimation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../samplics.estimation.html#module-samplics.estimation.expansion">samplics.estimation.expansion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../samplics.estimation.html#module-samplics.estimation.regression">samplics.estimation.regression</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../samplics.estimation.html#module-samplics.estimation.replication">samplics.estimation.replication</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../samplics.sae.html">Small Area Estimation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../samplics.sae.html#samplics-sae-eb-area-model">samplics.sae.eb_area_model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../samplics.sae.html#module-samplics.sae.eb_unit_model">samplics.sae.eb_unit_model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../samplics.utils.html">Utils</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../samplics.utils.html#module-samplics.utils.checks">samplics.utils.checks module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../samplics.utils.html#module-samplics.utils.formats">samplics.utils.formats module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../samplics.utils.html#module-samplics.utils.hadamard">samplics.utils.hadamard module</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for samplics.sae.eb_unit_model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;EB  for the unit level model.</span>

<span class="sd">This module implements the basic EB unit level model. The functionalities are organized in</span>
<span class="sd">classes. Each class has three main methods: *fit()*, *predict()* and *bootstrap_mse()*. </span>
<span class="sd">Linear Mixed Models (LMM) are the core underlying statistical framework used to model the hierarchical nature of the small area estimation (SAE) techniques implemented in this module, see McCulloch, C.E. and Searle, S.R. (2001) [#ms2001]_ for more details on LMM.</span>

<span class="sd">The *EbUnitModel* class implements the model developed by Molina, I. and Rao, J.N.K. (2010)</span>
<span class="sd">[#mr2010]_. So far, only the basic approach requiring the normal distribution of the errors is </span>
<span class="sd">implemented. This approach allows estimating complex indicators such as poverty indices and </span>
<span class="sd">other nonlinear paramaters. The class fits the model parameters using REML or ML. To predict the </span>
<span class="sd">area level indicators estimates, a Monte Carlo (MC) approach is used. MSE estimation is achieved </span>
<span class="sd">using a bootstrap procedure.  </span>

<span class="sd">For a comprehensive review of the small area estimation models and its applications, </span>
<span class="sd">see Rao, J.N.K. and Molina, I. (2015) [#rm2015]_.</span>

<span class="sd">.. [#ms2001] McCulloch, C.E.and Searle, S.R. (2001), *Generalized, Linear, Mixed Models*, </span>
<span class="sd">   New York: John Wiley &amp; Sons, Inc.</span>
<span class="sd">.. [#mr2010] Molina, , I. and Rao, J.N.K. (2010), Small Area Estimation of Poverty Indicators, </span>
<span class="sd">   *Canadian Journal of Statistics*, **38**, 369-385.</span>
<span class="sd">.. [#rm2015] Rao, J.N.K. and Molina, I. (2015), *Small area estimation, 2nd edn.*, </span>
<span class="sd">   John Wiley &amp; Sons, Hoboken, New Jersey.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="kn">from</span> <span class="nn">samplics.sae.eblup_unit_model</span> <span class="kn">import</span> <span class="n">EblupUnitModel</span>
<span class="kn">from</span> <span class="nn">samplics.utils</span> <span class="kn">import</span> <span class="n">basic_functions</span><span class="p">,</span> <span class="n">formats</span>
<span class="kn">from</span> <span class="nn">samplics.utils.types</span> <span class="kn">import</span> <span class="n">Array</span><span class="p">,</span> <span class="n">DictStrNum</span><span class="p">,</span> <span class="n">Number</span>


<div class="viewcode-block" id="EbUnitModel"><a class="viewcode-back" href="../../../samplics.sae.html#samplics.sae.eb_unit_model.EbUnitModel">[docs]</a><span class="k">class</span> <span class="nc">EbUnitModel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;*EbUnitModel* implements the basic Unit level model for complex indicators.</span>

<span class="sd">    *EbUnitModel* takes the sample data as input and fits the basic linear mixed model.</span>
<span class="sd">    The user can pick between restricted maximum likelihood (REML) or maximum likelihood (ML)</span>
<span class="sd">    to fit the model parameters. Also, EbUnitModel predicts the areas means and provides</span>
<span class="sd">    the point and mean squared error (MSE) estimates of the empirical Bayes linear</span>
<span class="sd">    unbiased (EBLUP). User can also obtain the bootstrap mse estimates of the MSE.</span>

<span class="sd">    *EbUnitModel* requires the user to provide the indicator function. The indicator function is</span>
<span class="sd">    expected to take the array of output sample observations as input and possibly some additional</span>
<span class="sd">    parameters needed to compute the indicator. The indicator function outputs an aggregated value.</span>
<span class="sd">    For example, the poverty gap indicator can have the following signature</span>
<span class="sd">    pov_gap(y: array, pov_line: float) -&gt; float. If the indicator function different outputs by</span>
<span class="sd">    area then the self.area_list can be used to incorporate different logics across areas.</span>

<span class="sd">    Also, *EbUnitModel* can use Boxcox to transform the output sample values in order to reduce</span>
<span class="sd">    the asymmetry in the datawhen fitting the linear mixed model.</span>

<span class="sd">    Setting attributes</span>
<span class="sd">        | method (str): the fitting method of the model parameters which can take the possible</span>
<span class="sd">        |   values restricted maximum likelihood (REML) or maximum likelihood (ML).</span>
<span class="sd">        |   If not specified, &quot;REML&quot; is used as default.</span>
<span class="sd">        | indicator (function): a user defined function to compute the indicator.</span>
<span class="sd">        | boxcox (dict): contains the *lambda* parameter of the Boxcox and a constant for the</span>
<span class="sd">        | log-transformation of the Boxcox.</span>

<span class="sd">    Sample related attributes</span>
<span class="sd">        | ys (array): the output sample observations.</span>
<span class="sd">        | Xs (ndarray): the auxiliary information.</span>
<span class="sd">        | scales (array): an array of scaling parameters for the unit levels errors.</span>
<span class="sd">        | afactors (array): sum of the inverse squared of scale.</span>
<span class="sd">        | areas (array): the full vector of small areas from the sampled observations.</span>
<span class="sd">        | areas_list (array): the list of small areas from the sample data.</span>
<span class="sd">        | samp_size (dict): the sample size per small areas from the sample.</span>
<span class="sd">        | ys_mean (array): sample area means of the output variable.</span>
<span class="sd">        | Xs_mean (ndarray): sample area means of the auxiliary variables.</span>

<span class="sd">    Model fitting attributes</span>
<span class="sd">        | fitted (boolean): indicates whether the model has been fitted or not.</span>
<span class="sd">        | fixed_effects (array): the estimated fixed effects of the regression model.</span>
<span class="sd">        | fe_std (array): the estimated standard errors of the fixed effects.</span>
<span class="sd">        | random_effects (array): the estimated area level random effects.</span>
<span class="sd">        |   associated with the small areas.</span>
<span class="sd">        | re_std (number): the estimated standard error of the random effects.</span>
<span class="sd">        | error_std (number): standard error of the unit level residuals.</span>
<span class="sd">        | convergence (dict): a dictionnary holding the convergence status and the number of</span>
<span class="sd">        |   iterations from the model fitting algorithm.</span>
<span class="sd">        | goodness (dict): a dictionary holding the log-likelihood, AIC, and BIC.</span>
<span class="sd">        | gamma (dict): ratio of the between-area variability (re_std**2) to the total</span>
<span class="sd">        |   variability (re_std**2 + error_std**2 / a_factor).</span>

<span class="sd">    Prediction related attributes</span>
<span class="sd">        | areap (array): the list of areas for the prediction.</span>
<span class="sd">        | number_reps (int): number of replicates for the bootstrap MSE estimation.</span>
<span class="sd">        | area_est (array): area level EBLUP estimates.</span>
<span class="sd">        | area_mse (array): area level taylor estimation of the MSE.</span>
<span class="sd">        | area_mse_boot (array): area level bootstrap estimation of the MSE.</span>

<span class="sd">    Main methods</span>
<span class="sd">        | fit(): fits the linear mixed model to estimate the model parameters using REMl or ML</span>
<span class="sd">        |   methods.</span>
<span class="sd">        | predict(): predicts the area level indicator estimates which includes both the point</span>
<span class="sd">        |   estimates and the taylor MSE estimate.</span>
<span class="sd">        | bootstrap_mse(): computes the area level bootstrap MSE estimates of the indicator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;REML&quot;</span><span class="p">,</span>
        <span class="n">boxcox</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">constant</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="c1"># Setting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;REML&quot;</span><span class="p">,</span> <span class="s2">&quot;ML&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Value provided for method is not valid!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span><span class="p">:</span> <span class="nb">int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lambda&quot;</span><span class="p">:</span> <span class="n">boxcox</span><span class="p">,</span> <span class="s2">&quot;constant&quot;</span><span class="p">:</span> <span class="n">constant</span><span class="p">}</span>

        <span class="c1"># Sample data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scales</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">afactors</span><span class="p">:</span> <span class="n">DictStrNum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ys</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">areas_list</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samp_size</span><span class="p">:</span> <span class="n">DictStrNum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ys_mean</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xs_mean</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>

        <span class="c1"># Fitted data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed_effects</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fe_std</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_effects</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">re_std</span><span class="p">:</span> <span class="nb">float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_std</span><span class="p">:</span> <span class="nb">float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goodness</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># loglikehood, deviance, AIC, BIC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">:</span> <span class="n">DictStrNum</span>

        <span class="c1"># Predict(ion/ed) data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_reps</span><span class="p">:</span> <span class="nb">int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area_est</span><span class="p">:</span> <span class="n">DictStrNum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area_mse</span><span class="p">:</span> <span class="n">DictStrNum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area_mse_boot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DictStrNum</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">inverse</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inverse</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inverse</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span>

<div class="viewcode-block" id="EbUnitModel.fit"><a class="viewcode-back" href="../../../samplics.sae.html#samplics.sae.eb_unit_model.EbUnitModel.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ys</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
        <span class="n">Xs</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
        <span class="n">areas</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
        <span class="n">samp_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scales</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">intercept</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-8</span><span class="p">,</span>
        <span class="n">maxiter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fits the linear mixed models to estimate the model parameters that is the fixed</span>
<span class="sd">        effects, the random effects standard error and the unit level residuals&#39; standard error.</span>
<span class="sd">        In addition, the method provides statistics related to the model fitting e.g. convergence</span>
<span class="sd">        status, log-likelihood, AIC, BIC, and more.</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (Array): An array of the output sample observations.</span>
<span class="sd">            Xs (Array): An multi-dimensional array of the sample auxiliary information.</span>
<span class="sd">            areas (Array): provides the area of the sampled observations.</span>
<span class="sd">            samp_weight (Optional[Array], optional): An array of the sample weights.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            scales (Union[Array, Number], optional): the scale factor for the unit level errors.</span>
<span class="sd">                If a single number of provided, the same number will be applied to all observations. Defaults to 1.</span>
<span class="sd">            intercept (bool, optional): An boolean to indicate whether an intercept need to be</span>
<span class="sd">                added to Xs. Defaults to True</span>
<span class="sd">            tol (float, optional): tolerance used for convergence criteria. Defaults to 1.0e-4.</span>
<span class="sd">            maxiter (int, optional): maximum number of iterations for the fitting algorithm.</span>
<span class="sd">            Defaults to 100.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ys</span> <span class="o">=</span> <span class="n">formats</span><span class="o">.</span><span class="n">numpy_array</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>

        <span class="n">ys_transformed</span> <span class="o">=</span> <span class="n">basic_functions</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
            <span class="n">ys</span><span class="p">,</span>
            <span class="n">llambda</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">],</span>
            <span class="n">constant</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">],</span>
            <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">eblup_ul</span> <span class="o">=</span> <span class="n">EblupUnitModel</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">eblup_ul</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">ys_transformed</span><span class="p">,</span> <span class="n">Xs</span><span class="p">,</span> <span class="n">areas</span><span class="p">,</span> <span class="n">samp_weight</span><span class="p">,</span> <span class="n">scales</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scales</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">scales</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ys</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">ys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xs</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">Xs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">areas</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">areas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">areas_list</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">areas_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">afactors</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">afactors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_std</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">error_std</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed_effects</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">fixed_effects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fe_std</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">fe_std</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">re_std</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">re_std</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">convergence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goodness</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">goodness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ys_mean</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">ys_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xs_mean</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">Xs_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samp_size</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">samp_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="n">eblup_ul</span><span class="o">.</span><span class="n">fitted</span></div>

    <span class="k">def</span> <span class="nf">_predict_indicator</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">number_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">y_s</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">X_s</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">area_s</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">X_r</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">area_r</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">arear_list</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">fixed_effects</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">sigma2e</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">sigma2u</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">intercept</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">max_array_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">indicator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">intercept</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xs_mean</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xs_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Xs_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xs_mean</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Xs_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xs_mean</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xs_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xs_mean</span>

        <span class="n">nb_arear</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arear_list</span><span class="p">)</span>
        <span class="n">mu_r</span> <span class="o">=</span> <span class="n">X_r</span> <span class="o">@</span> <span class="n">fixed_effects</span>

        <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
            <span class="n">bar_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">nb_arear</span><span class="p">)</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nb_arear</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bar_length</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating the </span><span class="si">{</span><span class="n">number_samples</span><span class="si">}</span><span class="s2"> replicates samples&quot;</span><span class="p">)</span>

        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_samples</span><span class="p">,</span> <span class="n">nb_arear</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arear_list</span><span class="p">):</span>
            <span class="c1"># print(d)</span>
            <span class="n">oos</span> <span class="o">=</span> <span class="n">area_r</span> <span class="o">==</span> <span class="n">d</span>
            <span class="n">mu_dr</span> <span class="o">=</span> <span class="n">mu_r</span><span class="p">[</span><span class="n">oos</span><span class="p">]</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas_list</span> <span class="o">==</span> <span class="n">d</span>
            <span class="n">ybar_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ys_mean</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span>
            <span class="n">xbar_d</span> <span class="o">=</span> <span class="n">Xs_mean</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span>
            <span class="n">mu_bias_dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ybar_d</span> <span class="o">-</span> <span class="n">xbar_d</span> <span class="o">@</span> <span class="n">fixed_effects</span><span class="p">)</span>
            <span class="n">scale_dr</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="n">oos</span><span class="p">]</span>
            <span class="n">N_dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">oos</span><span class="p">)</span>
            <span class="n">cycle_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_array_length</span> <span class="o">//</span> <span class="n">N_dr</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">number_cycles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number_samples</span> <span class="o">//</span> <span class="n">cycle_size</span><span class="p">)</span>
            <span class="n">last_cycle_size</span> <span class="o">=</span> <span class="n">number_samples</span> <span class="o">%</span> <span class="n">cycle_size</span>

            <span class="n">y_dr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_cycles</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">number_cycles</span><span class="p">:</span>
                    <span class="n">cycle_size</span> <span class="o">=</span> <span class="n">last_cycle_size</span>
                <span class="n">re_effects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                    <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="n">sigma2u</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">[</span><span class="n">d</span><span class="p">]))</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="n">cycle_size</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                    <span class="n">scale</span><span class="o">=</span><span class="n">scale_dr</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma2e</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">cycle_size</span><span class="p">,</span> <span class="n">N_dr</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">y_dr_j</span> <span class="o">=</span> <span class="n">mu_dr</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">mu_bias_dr</span> <span class="o">+</span> <span class="n">re_effects</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">errors</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">y_dr</span> <span class="o">=</span> <span class="n">y_dr_j</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y_dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_dr</span><span class="p">,</span> <span class="n">y_dr_j</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">[%-</span><span class="si">{</span><span class="n">bar_length</span><span class="si">}</span><span class="s2">s] %d%%&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="n">bar_length</span><span class="p">)),</span>
                        <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="n">y_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_dr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">y_s</span><span class="p">[</span><span class="n">area_s</span> <span class="o">==</span> <span class="n">d</span><span class="p">],</span> <span class="p">[</span><span class="n">number_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">z_d</span> <span class="o">=</span> <span class="n">basic_functions</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                <span class="n">y_d</span><span class="p">,</span>
                <span class="n">llambda</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">],</span>
                <span class="n">constant</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">],</span>
                <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">eta</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">arr</span><span class="o">=</span><span class="n">z_d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># *)</span>

        <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<div class="viewcode-block" id="EbUnitModel.predict"><a class="viewcode-back" href="../../../samplics.sae.html#samplics.sae.eb_unit_model.EbUnitModel.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">Xr</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
        <span class="n">arear</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
        <span class="n">indicator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Array</span><span class="p">],</span>
        <span class="n">number_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">scaler</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">intercept</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">max_array_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">100e6</span><span class="p">),</span>
        <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Predicts the area level means and provides the taylor MSE estimation of the estimated</span>
<span class="sd">        area means.</span>

<span class="sd">        Args:</span>
<span class="sd">            Xr (Array): an multi-dimensional array of the out of sample auxiliary variables.</span>
<span class="sd">            arear (Array): provides the area of the out of sample units.</span>
<span class="sd">            indicator (Callable[..., Array]): a user defined function which computes the area level</span>
<span class="sd">                indicators. The function should take y (output variable) as the first parameters,</span>
<span class="sd">                additional parameters can be used. Use ***kwargs* to transfer the additional</span>
<span class="sd">                parameters.</span>
<span class="sd">            number_samples (int): number of replicates for the Monte-Carlo (MC) algorithm.</span>
<span class="sd">            scaler (Union[Array, Number], optional): the scale factor for the unit level errors.</span>
<span class="sd">                If a single number of provided, the same number will be applied to all observations. Defaults to 1.</span>
<span class="sd">            intercept (bool, optional): An boolean to indicate whether an intercept need to be</span>
<span class="sd">                added to Xr. Defaults to True.</span>
<span class="sd">            max_array_length (int, optional): controls the number of replicates to generate at</span>
<span class="sd">                the same time. This parameter helps with performance. The number can be reduce or</span>
<span class="sd">                increase based on the user&#39;s computer RAM capacity. Defaults to int(100e6).</span>
<span class="sd">            show_progress (bool, optional): shows a bar progress of the MC replicates</span>
<span class="sd">                calculations. Defaults to True.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: when predict() is called before fitting the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;The model must be fitted first with .fit() before running the prediction.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number_samples</span><span class="p">)</span>

        <span class="n">Xr</span> <span class="o">=</span> <span class="n">formats</span><span class="o">.</span><span class="n">numpy_array</span><span class="p">(</span><span class="n">Xr</span><span class="p">)</span>
        <span class="n">arear</span> <span class="o">=</span> <span class="n">formats</span><span class="o">.</span><span class="n">numpy_array</span><span class="p">(</span><span class="n">arear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arear_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">arear</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scaler</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Xr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaler</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">formats</span><span class="o">.</span><span class="n">numpy_array</span><span class="p">(</span><span class="n">scaler</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">intercept</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Xr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">Xr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Xr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Xr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">Xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Xr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Xr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">Xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xs</span>

        <span class="n">area_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_indicator</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ys</span><span class="p">,</span>
            <span class="n">Xs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">,</span>
            <span class="n">Xr</span><span class="p">,</span>
            <span class="n">arear</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arear_list</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed_effects</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_std</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_std</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">scaler</span><span class="p">,</span>
            <span class="n">intercept</span><span class="p">,</span>
            <span class="n">max_array_length</span><span class="p">,</span>
            <span class="n">indicator</span><span class="p">,</span>
            <span class="n">show_progress</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">area_est</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arear_list</span><span class="p">,</span> <span class="n">area_est</span><span class="p">))</span></div>

<div class="viewcode-block" id="EbUnitModel.bootstrap_mse"><a class="viewcode-back" href="../../../samplics.sae.html#samplics.sae.eb_unit_model.EbUnitModel.bootstrap_mse">[docs]</a>    <span class="k">def</span> <span class="nf">bootstrap_mse</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">Xr</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
        <span class="n">arear</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
        <span class="n">indicator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Array</span><span class="p">],</span>
        <span class="n">number_reps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">scaler</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">intercept</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
        <span class="n">maxiter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">max_array_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">100e6</span><span class="p">),</span>
        <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Computes the MSE bootstrap estimates of the area level indicator estimates.</span>

<span class="sd">        Args:</span>
<span class="sd">            Xr (Array): an multi-dimensional array of the out of sample auxiliary variables.</span>
<span class="sd">            arear (Array): provides the area of the out of sample units.</span>
<span class="sd">            indicator (Callable[..., Array]): [description]</span>
<span class="sd">            number_reps (int): [description]</span>
<span class="sd">            scaler (Union[Array, Number], optional): [description]. Defaults to 1.</span>
<span class="sd">            intercept (bool, optional): [description]. Defaults to True.</span>
<span class="sd">            tol (float, optional): tolerance used for convergence criteria. Defaults to 1.0e-4.</span>
<span class="sd">            maxiter (int, optional): maximum number of iterations for the fitting algorithm.</span>
<span class="sd">            Defaults to 100.</span>
<span class="sd">            max_array_length (int, optional): [description]. Defaults to int(100e6).</span>
<span class="sd">            show_progress (bool, optional): shows a bar progress of the bootstrap replicates</span>
<span class="sd">                calculations. Defaults to True.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">X_r</span> <span class="o">=</span> <span class="n">formats</span><span class="o">.</span><span class="n">numpy_array</span><span class="p">(</span><span class="n">Xr</span><span class="p">)</span>
        <span class="n">area_r</span> <span class="o">=</span> <span class="n">formats</span><span class="o">.</span><span class="n">numpy_array</span><span class="p">(</span><span class="n">arear</span><span class="p">)</span>
        <span class="n">arear_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">area_r</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">intercept</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">X_r</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">X_r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">X_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">X_r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">Xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">X_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">X_r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">Xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xs</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scaler</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">scale_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">X_r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaler</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale_r</span> <span class="o">=</span> <span class="n">formats</span><span class="o">.</span><span class="n">numpy_array</span><span class="p">(</span><span class="n">scaler</span><span class="p">)</span>

        <span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">area_r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas_list</span><span class="p">)</span>
        <span class="n">areas_ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">area_r</span><span class="p">[</span><span class="n">ps</span><span class="p">])</span>
        <span class="n">nb_areas_ps</span> <span class="o">=</span> <span class="n">areas_ps</span><span class="o">.</span><span class="n">size</span>
        <span class="n">area_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">,</span> <span class="n">arear_list</span><span class="p">)]</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">area_r</span><span class="p">,</span> <span class="n">area_s</span><span class="p">)</span>
        <span class="n">scale_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scales</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">,</span> <span class="n">arear_list</span><span class="p">)]</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scale_r</span><span class="p">,</span> <span class="n">scale_s</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">N_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">X_s</span> <span class="o">=</span> <span class="n">Xs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">,</span> <span class="n">arear_list</span><span class="p">)]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_r</span><span class="p">,</span> <span class="n">X_s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">aboot_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nb_areas_ps</span><span class="p">)</span>

        <span class="n">indice_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">area_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">scale_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">scale_s_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">a_factor_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sample_size_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">X_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">X_s_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arear_list</span><span class="p">):</span>
            <span class="n">area_ds</span> <span class="o">=</span> <span class="n">area_s</span> <span class="o">==</span> <span class="n">d</span>
            <span class="n">indice_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span> <span class="o">==</span> <span class="n">d</span>
            <span class="n">area_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span><span class="p">[</span><span class="n">indice_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]]</span>
            <span class="n">scale_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="n">indice_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]]</span>
            <span class="n">a_factor_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">afactors</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas_list</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">sample_size_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samp_size</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas_list</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">scale_s_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_s</span><span class="p">[</span><span class="n">area_ds</span><span class="p">]</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas_list</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">X_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">indice_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]]</span>
            <span class="n">X_s_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_s</span><span class="p">[</span><span class="n">area_ds</span><span class="p">]</span>

        <span class="n">cycle_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_array_length</span> <span class="o">//</span> <span class="nb">sum</span><span class="p">(</span><span class="n">N_d</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">number_cycles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number_reps</span> <span class="o">//</span> <span class="n">cycle_size</span><span class="p">)</span>
        <span class="n">last_cycle_size</span> <span class="o">=</span> <span class="n">number_reps</span> <span class="o">%</span> <span class="n">cycle_size</span>
        <span class="n">number_cycles</span> <span class="o">=</span> <span class="n">number_cycles</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">last_cycle_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">number_cycles</span>

        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bar_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">number_cycles</span> <span class="o">*</span> <span class="n">nb_areas_ps</span><span class="p">)</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">number_cycles</span> <span class="o">*</span> <span class="n">nb_areas_ps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bar_length</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">eta_pop_boot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_reps</span><span class="p">,</span> <span class="n">nb_areas_ps</span><span class="p">))</span>
        <span class="n">eta_samp_boot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_reps</span><span class="p">,</span> <span class="n">nb_areas_ps</span><span class="p">))</span>
        <span class="n">y_samp_boot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_reps</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sample_size_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())))))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating the </span><span class="si">{</span><span class="n">number_reps</span><span class="si">}</span><span class="s2"> bootstrap replicate populations&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_cycles</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">cycle_size</span>
            <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cycle_size</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="n">number_cycles</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">number_reps</span>
                <span class="n">cycle_size</span> <span class="o">=</span> <span class="n">last_cycle_size</span>

            <span class="n">yboot_s</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">areas_ps</span><span class="p">):</span>
                <span class="n">aboot_factor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_factor_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>

                <span class="n">re_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                    <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">re_std</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="n">cycle_size</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">err_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                    <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">error_std</span> <span class="o">*</span> <span class="n">scale_dict</span><span class="p">[</span><span class="n">d</span><span class="p">],</span>
                    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">cycle_size</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indice_dict</span><span class="p">[</span><span class="n">d</span><span class="p">])),</span>
                <span class="p">)</span>
                <span class="n">yboot_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_effects</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">re_d</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">err_d</span>
                <span class="n">zboot_d</span> <span class="o">=</span> <span class="n">basic_functions</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                    <span class="n">yboot_d</span><span class="p">,</span>
                    <span class="n">llambda</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">],</span>
                    <span class="n">constant</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boxcox</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">],</span>
                    <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">eta_pop_boot</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">indicator</span><span class="p">(</span><span class="n">zboot_d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">yboot_s</span> <span class="o">=</span> <span class="n">yboot_d</span><span class="p">[:,</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">sample_size_dict</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">yboot_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yboot_s</span><span class="p">,</span> <span class="n">yboot_d</span><span class="p">[:,</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">sample_size_dict</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
                    <span class="n">run_id</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">nb_areas_ps</span> <span class="o">+</span> <span class="n">i</span>
                    <span class="k">if</span> <span class="n">run_id</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">[%-</span><span class="si">{</span><span class="n">bar_length</span><span class="si">}</span><span class="s2">s] %d%%&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="n">bar_length</span><span class="p">)),</span>
                            <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="p">)</span>

            <span class="n">y_samp_boot</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">yboot_s</span>

        <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bar_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">number_reps</span><span class="p">)</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">number_reps</span><span class="p">,</span> <span class="n">bar_length</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">reml</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;REML&quot;</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="c1"># with warnings.catch_warnings():</span>
        <span class="c1">#     warnings.filterwarnings(&quot;ignore&quot;)</span>
        <span class="c1">#     beta_ols = sm.OLS(y_samp_boot[0, :], X_s).fit().params</span>
        <span class="c1"># resid_ols = y_samp_boot[0, :] - np.matmul(X_s, beta_ols)</span>
        <span class="c1"># re_ols = basic_functions.sumby(area_s, resid_ols) / basic_functions.sumby(</span>
        <span class="c1">#     area_s, np.ones(area_s.size)</span>
        <span class="c1"># )</span>
        <span class="n">fit_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tol&quot;</span><span class="p">:</span> <span class="n">tol</span><span class="p">,</span>
            <span class="s2">&quot;gtol&quot;</span><span class="p">:</span> <span class="n">tol</span><span class="p">,</span>
            <span class="c1"># &quot;pgtol&quot;: tol,</span>
            <span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="n">maxiter</span><span class="p">,</span>
        <span class="p">}</span>  <span class="c1"># TODO: to improve in the future. Check: statsmodels.LikelihoodModel.fit()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitting and predicting using each of the </span><span class="si">{</span><span class="n">number_reps</span><span class="si">}</span><span class="s2"> bootstrap populations&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_reps</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                <span class="n">boot_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">MixedLM</span><span class="p">(</span><span class="n">y_samp_boot</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:],</span> <span class="n">X_s</span><span class="p">,</span> <span class="n">area_s</span><span class="p">)</span>
                <span class="n">boot_fit</span> <span class="o">=</span> <span class="n">boot_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                    <span class="n">reml</span><span class="o">=</span><span class="n">reml</span><span class="p">,</span>
                    <span class="c1"># start_params=np.append(beta_ols, np.std(re_ols) ** 2),</span>
                    <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">fit_kwargs</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">gammaboot</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">boot_fit</span><span class="o">.</span><span class="n">cov_re</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">boot_fit</span><span class="o">.</span><span class="n">cov_re</span><span class="p">)</span> <span class="o">+</span> <span class="n">boot_fit</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">aboot_factor</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">eta_samp_boot</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_indicator</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span><span class="p">,</span>
                <span class="n">y_samp_boot</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:],</span>
                <span class="n">X_s</span><span class="p">,</span>
                <span class="n">area_s</span><span class="p">,</span>
                <span class="n">X_r</span><span class="p">,</span>
                <span class="n">area_r</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">area_r</span><span class="p">),</span>
                <span class="n">boot_fit</span><span class="o">.</span><span class="n">fe_params</span><span class="p">,</span>
                <span class="n">gammaboot</span><span class="p">,</span>
                <span class="n">boot_fit</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">boot_fit</span><span class="o">.</span><span class="n">cov_re</span><span class="p">),</span>
                <span class="n">scale_r</span><span class="p">,</span>
                <span class="n">intercept</span><span class="p">,</span>
                <span class="n">max_array_length</span><span class="p">,</span>
                <span class="n">indicator</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">[%-</span><span class="si">{</span><span class="n">bar_length</span><span class="si">}</span><span class="s2">s] %d%%&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="n">bar_length</span><span class="p">)),</span>
                        <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">mse_boot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">eta_samp_boot</span> <span class="o">-</span> <span class="n">eta_pop_boot</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area_mse_boot</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arear_list</span><span class="p">,</span> <span class="n">mse_boot</span><span class="p">))</span></div>

<div class="viewcode-block" id="EbUnitModel.to_dataframe"><a class="viewcode-back" href="../../../samplics.sae.html#samplics.sae.eb_unit_model.EbUnitModel.to_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">col_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_area&quot;</span><span class="p">,</span> <span class="s2">&quot;_estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;_mse_boot&quot;</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns a pandas dataframe from dictionaries with same keys and one value per key.</span>

<span class="sd">        Args:</span>
<span class="sd">            col_names (list, optional): list of string to be used for the dataframe columns names.</span>
<span class="sd">                Defaults to [&quot;_area&quot;, &quot;_estimate&quot;, &quot;_mse_boot&quot;].</span>

<span class="sd">        Returns:</span>
<span class="sd">            [pd.DataFrame]: a pandas dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_names</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">area_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;No prediction yet. Must predict the area level estimates.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">area_mse_boot</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ncols</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;col_names must have 2 or 3 values&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">area_mse_boot</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">col_names</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># remove the last element same as .pop(-1)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">area_mse_boot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">area_df</span> <span class="o">=</span> <span class="n">formats</span><span class="o">.</span><span class="n">dict_to_dataframe</span><span class="p">(</span><span class="n">col_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">area_est</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">area_df</span> <span class="o">=</span> <span class="n">formats</span><span class="o">.</span><span class="n">dict_to_dataframe</span><span class="p">(</span><span class="n">col_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">area_est</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">area_mse_boot</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">area_df</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019-2020, samplics.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.4.<br/>
    </p>
  </div>
</footer>
  </body>
</html>